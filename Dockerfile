# ==============================================================
# ğŸ“¦ WhisperX + FasterWhisper Serverless (RunPod-ready)
# ×××ª ×“"×¨ × ×™×¦×Ÿ ××œ×™×§×™× â€“ ×’×¨×¡×” ×—×™× ××™×ª, ×œ×œ× PyAnnote ×•×œ×œ× HF_TOKEN
# ==============================================================

# ×©×œ×‘ 1: ×‘×¡×™×¡ CUDA
FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# --------------------------------------------------------------
# ×©×œ×‘ 2: ×”×ª×§× ×ª ×ª×œ×•×ª×™× ×‘×¡×™×¡×™×™×
# --------------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 python3-pip ffmpeg git \
        libsndfile1 libglib2.0-0 libsm6 libxrender1 libxext6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------------
# ×©×œ×‘ 3: ×”×’×“×¨×ª ×¡×‘×™×‘×ª ×¢×‘×•×“×”
# --------------------------------------------------------------
WORKDIR /app
COPY requirements.txt /app/requirements.txt

# --------------------------------------------------------------
# ×©×œ×‘ 4: ×”×ª×§× ×ª ×—×‘×™×œ×•×ª Python
# --------------------------------------------------------------
RUN pip install --upgrade pip && \
    pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu121 && \
    pip install git+https://github.com/m-bain/whisperX.git && \
    pip install -r requirements.txt

# --------------------------------------------------------------
# ×©×œ×‘ 5: ×”×¢×ª×§×ª ×”×§×‘×¦×™× ×©×œ ×”××¤×œ×™×§×¦×™×”
# --------------------------------------------------------------
COPY app.py handler.py /app/

# --------------------------------------------------------------
# ×©×œ×‘ 6: ××©×ª× ×™ ×¡×‘×™×‘×” (× ×™×ª×Ÿ ×œ×”×’×“×™×¨× ×‘×¨× ×¤×•×“)
# --------------------------------------------------------------
ENV WHISPER_MODEL=small
ENV PYTHONUNBUFFERED=1

# --------------------------------------------------------------
# ×©×œ×‘ 7: ×”×¤×¢×œ×ª RunPod handler (Serverless)
# --------------------------------------------------------------
CMD ["python3", "handler.py"]

