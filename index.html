<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¤ ×ª××œ×•×œ ×•×–×™×”×•×™ ×“×•×‘×¨×™× - RunPod Serverless</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; margin: 0;
    }
    .container {
      max-width: 1000px; margin: 0 auto; background: #fff; border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; padding: 28px 30px; text-align: center;
    }
    .header h1 { margin: 0 0 8px; }
    .content { padding: 24px 30px 36px; }
    .config-section { background:#f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 18px; }
    .config-row { display:flex; gap:14px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .config-row label { min-width:140px; font-weight:600; color:#444; }
    .config-row input, .config-row select {
      flex:1; min-width:260px; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px;
    }
    .hint { font-size:12px; color:#777; margin-top:-8px; margin-bottom:6px; }
    .upload-section {
      text-align:center; padding:30px; background:#f8f9fa; border-radius:12px;
      border:2px dashed #ddd; transition:.25s; cursor:pointer; margin-top:4px;
    }
    .upload-section:hover { border-color:#667eea; background:#f0f0ff; }
    .upload-section.active { border-color:#764ba2; background:#f5f0ff; }
    .file-input { display:none; }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; padding:12px 28px; border:none; border-radius:24px; font-weight:700; cursor:pointer;
      transition:.25s; margin: 10px 8px 0;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102,126,234,.35); }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .progress { display:none; margin:20px 0 12px; }
    .progress-bar { width:100%; height:26px; background:#eee; border-radius:14px; overflow:hidden; }
    .progress-fill {
      height:100%; background: linear-gradient(90deg, #667eea, #764ba2);
      width:0%; transition: width .25s; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;
    }
    .status-message { text-align:center; margin-top:8px; color:#666; font-style:italic; }
    .results-section { display:none; margin-top:24px; }
    .stats {
      background:#f8f9fa; border-radius:12px; padding:16px; margin-bottom:16px;
      display:flex; justify-content:space-around; gap:8px; text-align:center;
    }
    .stat-box { flex:1; }
    .stat-value { font-size:1.8em; font-weight:800; color:#667eea; }
    .stat-label { color:#666; margin-top:6px; }
    .transcript { background:#fff; border-radius:12px; padding:16px; max-height:520px; overflow:auto; border:1px solid #eee; }
    .segment { margin:12px 0; padding:12px; background:#f8f9fa; border-radius:8px; border-right:4px solid #667eea; }
    .speaker-label { font-weight:700; padding:2px 10px; border-radius:12px; background:#667eea; color:#fff; margin-right:8px; }
    .time-stamp { color:#999; font-size:.85em; margin-right:6px; }
    .text-content { margin-top:6px; line-height:1.6; color:#333; }
    .error { background:#fee; color:#a22; border:1px solid #fbb; padding:12px; border-radius:8px; margin:14px 0; }
    .export-buttons { margin-top:14px; text-align:center; }
    .tiny { font-size:11px; color:#7a7a7a; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤ ×ª××œ×•×œ ×•×–×™×”×•×™ ×“×•×‘×¨×™×</h1>
      <div class="tiny">RunPod Serverless â€¢ Faster-Whisper + Pyannote</div>
    </div>

    <div class="content">
      <!-- ×”×’×“×¨×•×ª -->
      <div class="config-section">
        <h3>âš™ï¸ ×”×’×“×¨×•×ª</h3>

        <div class="config-row">
          <label>×¡×•×’ ×—×™×‘×•×¨:</label>
          <select id="connectionType" onchange="updateConnectionSettings()">
            <option value="runpod" selected>RunPod Serverless</option>
            <option value="local">×©×¨×ª ××§×•××™ (FastAPI)</option>
          </select>
        </div>

        <!-- ×”×’×“×¨×•×ª RunPod -->
        <div id="runpodSettings">
          <div class="config-row">
            <label>RunPod API Key:</label>
            <input type="password" id="runpodKey" placeholder="runpod-xxxxxxxx..." />
          </div>
          <div class="hint">×”Ö¾API Key × ×©××¨ ×‘×œ×•×§××œÖ¾×¡×˜×•×¨×’â€™ ×©×œ ×”×“×¤×“×¤×Ÿ ×©×œ×š.</div>

          <div class="config-row">
            <label>Endpoint ID (v2):</label>
            <input type="text" id="endpointId" />
          </div>
          <div class="config-row">
            <label>Endpoint (slug/ref):</label>
            <input type="text" id="endpointRef" />
          </div>
        </div>

        <!-- ×”×’×“×¨×•×ª ×©×¨×ª ××§×•××™ -->
        <div id="localSettings" style="display:none;">
          <div class="config-row">
            <label>×›×ª×•×‘×ª ×©×¨×ª:</label>
            <input type="text" id="localUrl" value="http://localhost:8000" />
          </div>
        </div>

        <div class="config-row">
          <label>×©×¤×”:</label>
          <select id="language">
            <option value="he" selected>×¢×‘×¨×™×ª</option>
            <option value="en">English</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="fr">FranÃ§ais</option>
            <option value="es">EspaÃ±ol</option>
          </select>
        </div>
      </div>

      <!-- ×”×¢×œ××ª ×§×•×‘×¥ -->
      <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*" onchange="handleFileSelect(event)">
        <div style="font-size:46px; margin-bottom:10px;">ğŸ“</div>
        <h3>×œ×—×¥ ×›××Ÿ ××• ×’×¨×•×¨ ×§×•×‘×¥ ××•×“×™×•/×•×™×“××•</h3>
        <p id="fileName" style="margin-top: 8px; color: #666;">×ª×•××š ×‘: MP3, WAV, M4A, MP4, MOV ×•×¢×•×“â€¦</p>
      </div>

      <!-- ×›×¤×ª×•×¨ ×ª××œ×•×œ -->
      <div style="text-align:center; margin-top: 16px;">
        <button class="btn" id="transcribeBtn" onclick="startTranscription()" disabled>ğŸš€ ×”×ª×—×œ ×ª××œ×•×œ</button>
      </div>

      <!-- ×”×ª×§×“××•×ª -->
      <div class="progress" id="progress">
        <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
        <div class="status-message" id="statusMessage">××ª×—×™×œâ€¦</div>
      </div>

      <!-- ×ª×•×¦××•×ª -->
      <div class="results-section" id="results">
        <h2 style="text-align:center; margin-bottom:14px;">ğŸ“Š ×ª×•×¦××•×ª ×”×ª××œ×•×œ</h2>
        <div class="stats" id="stats"></div>
        <div class="transcript" id="transcript"></div>
        <div class="export-buttons">
          <button class="btn" onclick="exportToText()">ğŸ’¾ ×™×™×¦×•× ×›×˜×§×¡×˜</button>
          <button class="btn" onclick="exportToJSON()">ğŸ“‹ ×™×™×¦×•× ×›-JSON</button>
          <button class="btn" onclick="exportToSRT()">ğŸ¬ ×™×™×¦×•× ×›-SRT</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === Persist settings ===
    const persistIds = ["runpodKey", "endpointId", "endpointRef", "localUrl", "language"];
    function loadPersisted() {
      document.getElementById('endpointId').value = localStorage.getItem('endpointId')
        || 'rpa_1TXBNNOTREMNQ9M0RXXBKL6S857J2BO119XU8VKD3s81ri';
      document.getElementById('endpointRef').value = localStorage.getItem('endpointRef')
        || 'ljz2z2ys1psnrs';
      const savedKey = localStorage.getItem('runpodKey') || '';
      if (savedKey) document.getElementById('runpodKey').value = savedKey;
      const savedLang = localStorage.getItem('language') || 'he';
      document.getElementById('language').value = savedLang;
      const savedLocal = localStorage.getItem('localUrl') || 'http://localhost:8000';
      document.getElementById('localUrl').value = savedLocal;
    }
    function wirePersistence() {
      persistIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('change', () => localStorage.setItem(id, el.value));
        el.addEventListener('blur', () => localStorage.setItem(id, el.value));
      });
    }

    // === UI helpers ===
    let currentFile = null;
    let transcriptionResults = null;

    function updateConnectionSettings() {
      const type = document.getElementById('connectionType').value;
      document.getElementById('localSettings').style.display = type === 'local' ? 'block' : 'none';
      document.getElementById('runpodSettings').style.display = type === 'runpod' ? 'block' : 'none';
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        currentFile = file;
        document.getElementById('fileName').textContent =
          `×§×•×‘×¥ × ×‘×—×¨: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
        document.getElementById('transcribeBtn').disabled = false;
        document.querySelector('.upload-section').classList.add('active');
      }
    }

    // Drag & Drop
    const uploadSection = document.querySelector('.upload-section');
    uploadSection.addEventListener('dragover', e => { e.preventDefault(); uploadSection.classList.add('active'); });
    uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('active'));
    uploadSection.addEventListener('drop', e => {
      e.preventDefault();
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        document.getElementById('fileInput').files = files;
        handleFileSelect({ target: { files } });
      }
    });

    // === Main flow ===
    async function startTranscription() {
      try {
        if (!currentFile) throw new Error('×× × ×‘×—×¨ ×§×•×‘×¥');
        const type = document.getElementById('connectionType').value;

        // progress on
        document.getElementById('progress').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('transcribeBtn').disabled = true;
        updateProgress(10, '××›×™×Ÿ ×§×•×‘×¥â€¦');

        if (type === 'local') {
          await transcribeLocal();
        } else {
          await transcribeRunPod();
        }
      } catch (err) {
        console.error(err);
        showError(err.message || '×©×’×™××” ×œ× ×¦×¤×•×™×”');
      } finally {
        document.getElementById('transcribeBtn').disabled = false;
        document.getElementById('progress').style.display = 'none';
      }
    }

    async function transcribeLocal() {
      const url = document.getElementById('localUrl').value;
      const language = document.getElementById('language').value;

      const formData = new FormData();
      formData.append('file', currentFile);
      formData.append('language', language);

      updateProgress(30, '×©×•×œ×— ×œ×©×¨×ª ××§×•××™â€¦');
      const response = await fetch(`${url}/transcribe`, { method: 'POST', body: formData });

      updateProgress(70, '××¢×‘×“ ×ª×•×¦××•×ªâ€¦');
      if (!response.ok) throw new Error(`×©×’×™××ª ×©×¨×ª: ${response.status}`);

      const data = await response.json();
      updateProgress(100, '×”×•×©×œ×!');
      if (data.status === 'success') displayResults(data);
      else throw new Error(data.error || '×©×’×™××” ×‘×ª××œ×•×œ');
    }

    // === RunPod v2: run + poll status ===
    async function transcribeRunPod() {
      const apiKey = document.getElementById('runpodKey').value;
      const endpointId = document.getElementById('endpointId').value;
      const language = document.getElementById('language').value;

      if (!apiKey || !endpointId) throw new Error('×—×•×‘×” ×œ×”×–×™×Ÿ API Key ×•-Endpoint ID');

      updateProgress(25, '×××™×¨ ×§×•×‘×¥ ×œ-base64â€¦');
      const base64 = await fileToBase64(currentFile);

      updateProgress(45, '×©×•×œ×— ××©×™××” ×œ-RunPodâ€¦');
      const runRes = await fetch(`https://api.runpod.ai/v2/${endpointId}/run`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ input: { audio_base64: base64, language } })
      });

      const runText = await runRes.text();
      console.log('RunPod /run raw:', runText);
      let runData;
      try { runData = JSON.parse(runText); }
      catch { throw new Error('RunPod ×”×—×–×™×¨ ×ª×©×•×‘×” ×œ× ×ª×§×™× ×” ×‘×§×¨×™××ª run (×‘×“×•×§ API Key / Endpoint ID)'); }

      if (!runRes.ok) {
        throw new Error(runData?.message || runData?.error || `RunPod run error: ${runRes.status}`);
      }

      const runId = runData.id || runData.jobId || runData.executionId;
      const initStatus = runData.status;
      console.log('RunPod /run parsed:', runData);

      if (!runId) throw new Error('×œ× ×”×ª×§×‘×œ ××–×”×” ×¨×™×¦×” ×-RunPod');

      // Polling loop
      updateProgress(60, '×××ª×™×Ÿ ×œ×¢×™×‘×•×“ ×‘-RunPodâ€¦');
      let attempt = 0;
      const maxAttempts = 120; // ×¢×“ ~4 ×“×§×³ ×× interval=2s
      const intervalMs = 2000;

      while (attempt < maxAttempts) {
        attempt++;
        const statusUrl = `https://api.runpod.ai/v2/${endpointId}/status/${runId}`;
        const stRes = await fetch(statusUrl, { headers: { 'Authorization': `Bearer ${apiKey}` } });
        const stText = await stRes.text();
        console.log(`RunPod /status (${attempt}) raw:`, stText);

        let stData;
        try { stData = JSON.parse(stText); }
        catch { throw new Error('×ª×©×•×‘×ª ×¡×˜×˜×•×¡ ×œ× ×ª×§×™× ×” ×-RunPod'); }

        if (!stRes.ok) {
          const msg = stData?.message || stData?.error || `RunPod status error: ${stRes.status}`;
          throw new Error(msg);
        }

        const status = (stData.status || '').toUpperCase();
        if (status === 'COMPLETED' || status === 'FINISHED' || (stData.output && stData.output.status === 'success')) {
          const output = stData.output || stData;
          updateProgress(100, '×”×•×©×œ×!');
          if (output.status === 'success' && output.results) {
            displayResults(output);
          } else if (output.results) {
            // ×™×© ×ª×•×¦××•×ª ×’× ×‘×œ×™ status
            displayResults(output);
          } else {
            console.log('Completed status but unexpected payload:', stData);
            throw new Error('×”×¢×™×‘×•×“ ×”×•×©×œ× ××š ×œ× ×”×ª×§×‘×œ×• ×ª×•×¦××•×ª ×¦×¤×•×™×•×ª');
          }
          return;
        }

        if (status === 'FAILED' || status === 'ERROR') {
          const msg = stData?.error || stData?.message || '×”××©×™××” × ×›×©×œ×” ×‘-RunPod';
          throw new Error(msg);
        }

        // still running
        updateProgress(Math.min(95, 60 + Math.floor((attempt / maxAttempts) * 35)), `××¢×‘×“ ×‘-RunPodâ€¦ (${attempt})`);
        await new Promise(r => setTimeout(r, intervalMs));
      }

      throw new Error('×—×¨×™×’×” ××–××Ÿ ×”×”××ª× ×” ×œ×ª×•×¦××” ×-RunPod');
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = (reader.result || '').toString().split(',')[1] || '';
          if (!base64) reject(new Error('×›×©×œ ×‘××¨×ª base64'));
          else resolve(base64);
        };
        reader.onerror = reject;
      });
    }

    // === UI helpers ===
    function updateProgress(percent, message) {
      document.getElementById('progress').style.display = 'block';
      const fill = document.getElementById('progressFill');
      fill.style.width = percent + '%';
      fill.textContent = percent + '%';
      document.getElementById('statusMessage').textContent = message || '';
    }

    function displayResults(data) {
      transcriptionResults = data;

      const speakersCount = data.speakers_count || new Set(data.results.map(r => r.speaker)).size;
      const duration = data.results.length ? Math.round(data.results[data.results.length - 1].end) : 0;

      document.getElementById('stats').innerHTML = `
        <div class="stat-box"><div class="stat-value">${speakersCount}</div><div class="stat-label">×“×•×‘×¨×™× ×–×•×”×•</div></div>
        <div class="stat-box"><div class="stat-value">${data.results.length}</div><div class="stat-label">×§×˜×¢×™ ×˜×§×¡×˜</div></div>
        <div class="stat-box"><div class="stat-value">${formatTime(duration)}</div><div class="stat-label">××•×¨×š ×”×§×œ×˜×”</div></div>
      `;

      let html = '';
      data.results.forEach(seg => {
        html += `
          <div class="segment">
            <span class="speaker-label">${seg.speaker || 'SPEAKER'}</span>
            <span class="time-stamp">[${formatTime(seg.start)} - ${formatTime(seg.end)}]</span>
            <div class="text-content">${escapeHtml(seg.text || '')}</div>
          </div>
        `;
      });
      document.getElementById('transcript').innerHTML = html;
      document.getElementById('results').style.display = 'block';
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.innerHTML = `<strong>×©×’×™××”:</strong> ${escapeHtml(message)}`;
      document.querySelector('.content').insertBefore(errorDiv, document.getElementById('results'));
      setTimeout(() => errorDiv.remove(), 7000);
    }

    function escapeHtml(str) {
      return (str || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function formatTime(seconds=0) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2,'0')}`;
    }

    function formatSRTTime(seconds=0) {
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      const ms = Math.floor((seconds % 1) * 1000);
      return `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')},${ms.toString().padStart(3,'0')}`;
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // Exports
    function exportToText() {
      if (!transcriptionResults) return;
      let text = '×ª××œ×•×œ ××•×˜×•××˜×™ ×¢× ×–×™×”×•×™ ×“×•×‘×¨×™×\n================================\n\n';
      transcriptionResults.results.forEach(seg => {
        text += `[${formatTime(seg.start)}] ${seg.speaker}:\n${seg.text}\n\n`;
      });
      downloadFile(text, 'transcript.txt', 'text/plain');
    }
    function exportToJSON() {
      if (!transcriptionResults) return;
      const json = JSON.stringify(transcriptionResults, null, 2);
      downloadFile(json, 'transcript.json', 'application/json');
    }
    function exportToSRT() {
      if (!transcriptionResults) return;
      let srt = '';
      transcriptionResults.results.forEach((seg, i) => {
        srt += `${i+1}\n${formatSRTTime(seg.start)} --> ${formatSRTTime(seg.end)}\n[${seg.speaker}] ${seg.text}\n\n`;
      });
      downloadFile(srt, 'transcript.srt', 'text/plain');
    }

    // Init
    loadPersisted();
    wirePersistence();
    updateConnectionSettings();
  </script>
</body>
</html>
